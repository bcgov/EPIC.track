"""Add simple title column

Revision ID: 74e58a15d180
Revises: 2edbfb8b9c0e
Create Date: 2024-01-22 20:09:36.781375

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '74e58a15d180'
down_revision = '2edbfb8b9c0e'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('works', schema=None) as batch_op:
        batch_op.add_column(sa.Column('simple_title', sa.String(), nullable=True))
        batch_op.alter_column('title', type_=sa.String(length=150))


    with op.batch_alter_table('works_history', schema=None) as batch_op:
        batch_op.add_column(sa.Column('simple_title', sa.String(), autoincrement=False, nullable=True))
        batch_op.alter_column('title', type_=sa.String(length=150))

    # e.g. title Mt. Milligan Copper-Gold - Amendment - Certificate Modernization, set simple_title = Certificate Modernization
    op.execute("UPDATE works SET simple_title = TRIM(BOTH ' ' FROM split_part(title, '-', 3))")
    op.execute("UPDATE works_history SET simple_title = TRIM(BOTH ' ' FROM split_part(title, '-', 3))")

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('works_history', schema=None) as batch_op:
        batch_op.drop_column('simple_title')
        batch_op.alter_column('title', type_=sa.String(length=80))


    with op.batch_alter_table('works', schema=None) as batch_op:
        batch_op.drop_column('simple_title')
        batch_op.alter_column('title', type_=sa.String(length=80))

    # ### end Alembic commands ###
