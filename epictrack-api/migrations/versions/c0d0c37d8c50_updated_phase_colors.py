"""updated phase colors

Revision ID: c0d0c37d8c50
Revises: eb68451694da
Create Date: 2024-01-30 14:52:39.382058

"""
import json

import sqlalchemy as sa
from alembic import op

from api.models.work_type import WorkTypeEnum


# revision identifiers, used by Alembic.
revision = "c0d0c37d8c50"
down_revision = "eb68451694da"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("indigenous_works_history", schema=None) as batch_op:
        batch_op.alter_column(
            "indigenous_consultation_level_id",
            existing_type=sa.INTEGER(),
            nullable=False,
            autoincrement=False,
        )

    with op.batch_alter_table("works", schema=None) as batch_op:
        batch_op.alter_column(
            "simple_title",
            existing_type=sa.VARCHAR(length=30),
            type_=sa.String(length=50),
            existing_nullable=True,
        )

    with op.batch_alter_table("works_history", schema=None) as batch_op:
        batch_op.alter_column(
            "simple_title",
            existing_type=sa.VARCHAR(length=30),
            type_=sa.String(length=50),
            existing_nullable=True,
            autoincrement=False,
        )

    assessment_phases = [
        {"name": "Early Engagement", "ea_act_id": 3, "color": "#d4e0e2"},
        {
            "name": "DPD Development (Proponent Time)",
            "ea_act_id": 3,
            "color": "#d3d4d5",
        },
        {"name": "Readiness Decision", "ea_act_id": 3, "color": "#f6dad8"},
        {"name": "Further Readiness Decision", "ea_act_id": 3, "color": "#f6dad8"},
        {"name": "Process Planning", "ea_act_id": 3, "color": "#c0cddc"},
        {
            "name": "Application Development (Proponent Time)",
            "ea_act_id": 3,
            "color": "#d3d4d5",
        },
        {
            "name": "Effects Assessment & Recommendation",
            "ea_act_id": 3,
            "color": "#f9e9c4",
        },
        {
            "name": "Revised Application Development (Proponent Time)",
            "ea_act_id": 3,
            "color": "#d3d4d5",
        },
        {"name": "Application Review", "ea_act_id": 3, "color": "#d2e4f3"},
        {"name": "Decision", "ea_act_id": 3, "color": "#cbe0cf"},
        {"name": "Termination Decision", "ea_act_id": 3, "color": "#cbe0cf"},
    ]

    op.execute(
        f"""
        UPDATE phase_codes set color = phase.color FROM (
            SELECT * FROM json_populate_recordset(null::phase_codes,'%s')
        ) phase
        WHERE phase_codes.name = phase.name AND phase_codes.work_type_id = {WorkTypeEnum.ASSESSMENT.value} AND phase_codes.ea_act_id = phase.ea_act_id
        """
        % json.dumps(assessment_phases)
    )

    op.execute(
        f"UPDATE phase_codes SET color = '#e4dfec' WHERE phase_codes.work_type_id = {WorkTypeEnum.AMENDMENT.value}"
    )

    op.execute("UPDATE phase_codes SET color = '#003366' WHERE phase_codes.color = '#FFFFFF'")

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("works_history", schema=None) as batch_op:
        batch_op.alter_column(
            "simple_title",
            existing_type=sa.String(length=50),
            type_=sa.VARCHAR(length=30),
            existing_nullable=True,
            autoincrement=False,
        )

    with op.batch_alter_table("works", schema=None) as batch_op:
        batch_op.alter_column(
            "simple_title",
            existing_type=sa.String(length=50),
            type_=sa.VARCHAR(length=30),
            existing_nullable=True,
        )

    with op.batch_alter_table("indigenous_works_history", schema=None) as batch_op:
        batch_op.alter_column(
            "indigenous_consultation_level_id",
            existing_type=sa.INTEGER(),
            nullable=True,
            autoincrement=False,
        )

    # ### end Alembic commands ###
